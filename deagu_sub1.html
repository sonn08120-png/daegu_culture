<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/deagu_sub.css">
    <title>Document</title>
</head>

<body>
    <header>
        <div class="header_warp">
            <div class="nav_warp">
                <div class="nav">
                    <div class="nav_top">
                        <h1><a href="index.html"><img src="image/logo_color.png" alt="대구문화예술회관로고"></a></h1>
                        <div class="nav_my">
                            <a href=""><img src="image/login_02.png" alt="로그인">로그인</a>
                            <a href=""><img src="image/mypage_02.png" alt="마이페이지">마이페이지</a>
                        </div>
                    </div>
                    <div class="nav_bottom">
                        <ul>
                            <li><a href="">공연·전시</a></li>
                            <li><a href="">티켓예매</a></li>
                            <li><a href="">대관안내</a></li>
                            <li><a href="">문화예술교육</a></li>
                            <li><a href="">시립예술단</a></li>
                            <li><a href="">회관소개</a></li>
                            <li><a href="">열린광장</a></li>
                        </ul>
                        <div class="nav_bottom_img">
                            <a href=""><img src="image/Magnifier_02.png" alt="검색"></a>
                            <a href=""><img src="image/hambergur_02.png" alt="메뉴"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header_img">
            <b>공연정보</b>
        </div>
        <div class="snb_warp">
            <div class="snb">
                <div class="snb_left">
                    <div class="snb_home"><a href="">
                            <img src="image/home.png">
                        </a></div>
                    <div class="snb_map"><a href="">
                            <p>공연·전시</p>
                        </a></div>
                    <div class="snb_map"><a href="">
                            <p>공연정보</p>
                        </a></div>
                    <div class="snb_map"><a href="">
                            <b>월간일정</b>
                        </a></div>
                </div>
                <div class="snb_right">
                    <div class="d-flex flex-column flex-lg-row mb-3">
                        <div>
                            <button onclick="shareInvitation()" class="text-underline ">
                                <img src="image/share.png">
                            </button>
                        </div>
                    </div>
                    <script>
                        function copyToClipboard(text) {
                            navigator.clipboard.writeText(text)
                                .then(() => {
                                    console.log('클립보드에 복사되었습니다.');
                                    alert('내용이 클립보드에 복사되었습니다.');
                                })
                                .catch((error) => {
                                    console.error('클립보드 복사 실패', error);
                                });
                        }

                        function shareInvitation() {
                            const textToShare = '공유할 내용'; // 공유할 내용
                            const urlToShare = 'https://example.com' + "동적할당"; // 공유할 URL

                            if (navigator.share) {
                                navigator.share({
                                    title: '공유할 제목',
                                    text: textToShare,
                                    url: urlToShare,
                                })
                                    .then(() => {
                                        console.log('공유 성공');
                                    })
                            } else {
                                // navigator.share가 지원되지 않는 경우 클립보드에 복사
                                copyToClipboard(`${textToShare} ${urlToShare}`);
                            }
                        }
                    </script>
                    <button onclick="return  printPage();"><img src="image/print.png"></button>
                    <script>
                        let initBodyHtml;

                        const printPage = () => {
                            window.print();
                        }

                        const beforePrint = () => {
                            initBodyHtml = document.body.innerHTML;
                            document.body.innerHTML = document.getElementById("print").innerHTML;
                        }

                        const afterPrint = () => {
                            document.body.innerHTML = initBodyHtml;
                        }

                        window.onbeforeprint = beforePrint;
                        window.onafterprint = afterPrint;
                    </script>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="select">
            <div>
                <p>진행중인 공연</p>
            </div>
            <div>
                <p>월간일정</p>
            </div>
            <div>
                <p>연간일정</p>
            </div>
        </div>
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonth"><img src="image/calender_arrow_left.png"></button>
                <h2 id="currentMonth">2025.10</h2>
                <button id="nextMonth"><img src="image/calender_arrow_right.png"></button>
            </div>

            <div class="legend">
                <div class="legend-item"><span class="legend-dot dot-show"></span>예술단공연</div>
                <div class="legend-item"><span class="legend-dot dot-plan"></span>기획</div>
                <div class="legend-item"><span class="legend-dot dot-rent"></span>대관</div>
            </div>

            <table id="calendar"></table>
        </div>

        <script>
            /* === 달력 상태 === */
            const currentMonthEl = document.getElementById("currentMonth");
            const calendar = document.getElementById("calendar");
            let currentDate = new Date(2025, 9); // 10월 (0-indexed)

            /* === 일정 데이터 (url/img 있으면 popover 카드 생성) === */
            const rawEvents = [
                { date: "2025-10-02", type: "show", title: "미술관 라이브", url: "#" },
                { date: "2025-10-05", type: "show", title: "대구시립교향악단 <체임버시리즈>", url: "#" },
                { date: "2025-10-06", type: "show", title: "이상 프로젝트 ‘이상과 카프카’", url: "#" },
                { date: "2025-10-07", type: "show", title: "대구시립국악단 제29회 청소년 협주곡의 밤", url: "#" },
                { date: "2025-10-08", type: "show", title: "시립합창단 <가을의 노래>", url: "#" },
                { date: "2025-10-09", type: "rent", title: "남진 전국 투어 콘서트", url: "#" },
                { date: "2025-10-10", type: "rent", title: "지브리&디즈니 영화음악 Festa", url: "#" },
                { date: "2025-10-12", type: "plan", title: "금난새의 11시 데이트 (8월)", url: "#" },
                { date: "2025-10-15", type: "plan", title: "전통연회극 <광대>", url: "#", img: "image/poster_03.png" },
                { date: "2025-10-15", type: "plan", title: "음악극 <적로-이슬의 노래>", url: "#" },
                { date: "2025-10-15", type: "rent", title: "제80주년 광복절 경축 음악회", url: "#" },
                { date: "2025-10-16", type: "plan", title: "전통연회극 <광대>", url: "#", img: "image/poster_03.png" },
                { date: "2025-10-17", type: "rent", title: "대구시민과 함께하는 여름음악회", url: "#" },
                { date: "2025-10-20", type: "show", title: "대구국제금관·타악페스티벌", url: "#" },
            ];

            /* === 날짜별 그룹핑 === */
            const eventsByDate = rawEvents.reduce((acc, e) => {
                (acc[e.date] ||= []).push(e);
                return acc;
            }, {});

            /* === 달력 렌더 === */
            function renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                currentMonthEl.textContent = `${year}.${String(month + 1).padStart(2, "0")}`;

                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();

                let html = `
    <thead>
      <tr><th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr>
    </thead>
    <tbody><tr>
  `;

                for (let i = 0; i < firstDay; i++) html += "<td></td>";

                for (let i = 1; i <= lastDate; i++) {
                    const day = new Date(year, month, i).getDay();
                    const key = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
                    const dayEvents = eventsByDate[key] || [];

                    html += `<td><div class="cell-content"><div class="date">${i}</div><div class="events">`;

                    dayEvents.forEach((e) => {
                        const hasCard = e.url && e.img; // 둘 다 있을 때만 카드 표시
                        html += `
        <div class="event ${e.type}">
          <span class="event-dot dot-${e.type}"></span>
          <a class="event-title" href="${e.url || '#'}" target="_blank" rel="noopener">${e.title}</a>
          ${hasCard ? `
          <div class="event-popover" aria-hidden="true">
            <div class="popover-card">
              <img src="${e.img}" alt="${e.title}">
              <div class="popover-text">
                <div class="popover-title">${e.title}</div>
                <a href"#" class="popover-btn" href="${e.url}" target="_blank" rel="noopener">상세보기</a>
              </div>
            </div>
          </div>` : ``}
        </div>
      `;
                    });

                    html += `</div></div></td>`;
                    if (day === 6 && i !== lastDate) html += "</tr><tr>";
                }

                html += "</tr></tbody>";
                calendar.innerHTML = html;

                // 렌더 후 팝오버 위치 계산 부착
                attachPopoverPositioning();
            }

            /* === 팝오버 위치 계산 === */
            function attachPopoverPositioning() {
                const GAP = 10;   // 트리거와 카드 사이
                const MARGIN = 8; // 화면 가장자리 여백

                document.querySelectorAll(".event").forEach((evt) => {
                    const pop = evt.querySelector(".event-popover");
                    if (!pop) return;

                    const measureAndPlace = () => {
                        // 잠깐 보이게 해서 크기 측정
                        const prev = {
                            display: pop.style.display,
                            opacity: pop.style.opacity,
                            pointer: pop.style.pointerEvents,
                        };
                        pop.style.display = "block";
                        pop.style.opacity = "0";
                        pop.style.pointerEvents = "none";

                        requestAnimationFrame(() => {
                            const cardW = pop.offsetWidth || 280;
                            const cardH = pop.offsetHeight || 360;

                            const rect = evt.getBoundingClientRect();
                            const vw = window.innerWidth;
                            const vh = window.innerHeight;

                            // ✅ 기본: "아래"로 띄우기 (가로는 이벤트 시작점에 맞춤)
                            let left = 0;                          // .event의 왼쪽을 기준
                            let top = evt.offsetHeight + GAP;     // .event의 아래쪽

                            // ⬇️ 화면 하단을 넘치면 "위로" 뒤집기
                            if (rect.top + top + cardH > vh - MARGIN) {
                                top = -(cardH + GAP);
                            }

                            // ⬅️➡️ 좌우 보정 (화면 밖으로 못 나가게)
                            // 현재 pop의 절대 좌표 = rect.left + left
                            let absLeft = rect.left + left;
                            if (absLeft < MARGIN) {
                                left += (MARGIN - absLeft); // 왼쪽으로 나가면 오른쪽으로 밀기
                                absLeft = rect.left + left;
                            }
                            if (absLeft + cardW > vw - MARGIN) {
                                left -= (absLeft + cardW - (vw - MARGIN)); // 오른쪽으로 나가면 왼쪽으로 당기기
                            }

                            // 위치 적용 (absolute; 부모 .event 기준)
                            pop.style.left = `${left}px`;
                            pop.style.top = `${top}px`;

                            // 상태 복구 (hover 시 CSS로 표시)
                            pop.style.display = prev.display || "";
                            pop.style.opacity = prev.opacity || "";
                            pop.style.pointerEvents = prev.pointer || "";
                        });
                    };

                    evt.addEventListener("mouseenter", measureAndPlace);
                    evt.addEventListener("focusin", measureAndPlace);
                });
            }

            /* === 유틸: 디바운스 === */
            function debounce(fn, delay = 150) {
                let t;
                return (...args) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn.apply(null, args), delay);
                };
            }

            /* === 월 이동 === */
            document.getElementById("prevMonth").addEventListener("click", () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate);
            });
            document.getElementById("nextMonth").addEventListener("click", () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate);
            });

            /* === 리사이즈 시 포지션 재부착 === */
            window.addEventListener("resize", debounce(() => attachPopoverPositioning(), 200));

            /* === 초기 렌더 === */
            renderCalendar(currentDate);

            function wirePopoverOpenClose() {
                const OPEN_DELAY = 60;   // ms: 살짝 지연
                const CLOSE_DELAY = 140; // ms: 카드로 이동할 때 끊기지 않게

                document.querySelectorAll('.event').forEach(evt => {
                    const pop = evt.querySelector('.event-popover');
                    if (!pop) return;

                    let closeTimer = null, openTimer = null;

                    const open = () => {
                        clearTimeout(closeTimer);
                        if (evt.classList.contains('is-open')) return;
                        openTimer = setTimeout(() => evt.classList.add('is-open'), OPEN_DELAY);
                    };

                    const close = () => {
                        clearTimeout(openTimer);
                        closeTimer = setTimeout(() => evt.classList.remove('is-open'), CLOSE_DELAY);
                    };

                    // 트리거(제목/점) 영역
                    evt.addEventListener('mouseenter', open);
                    evt.addEventListener('mouseleave', close);
                    evt.addEventListener('focusin', open);   // 키보드 접근
                    evt.addEventListener('focusout', close);

                    // 카드 위에서도 열린 상태 유지
                    pop.addEventListener('mouseenter', () => {
                        clearTimeout(closeTimer);
                        evt.classList.add('is-open');
                    });
                    pop.addEventListener('mouseleave', close);

                    // 모바일/터치: 탭으로 토글 (외부 탭 시 닫힘)
                    evt.addEventListener('click', (e) => {
                        // 카드 내부 버튼 클릭은 그대로 통과
                        if (e.target.closest('.popover-btn')) return;
                        e.preventDefault();
                        evt.classList.toggle('is-open');
                    });
                    document.addEventListener('click', (e) => {
                        if (!evt.contains(e.target)) evt.classList.remove('is-open');
                    }, { capture: true });
                });
            }

            // 렌더 직후 호출
            wirePopoverOpenClose();
        </script>
    </main>
    <footer>
        <div class="footer_top">
            <ul>
                <li>공연관련<img src="image/small_arrow_top.png"></li>
                <li>전시관련<img src="image/small_arrow_top.png"></li>
                <li>교육관련<img src="image/small_arrow_top.png"></li>
                <li>유관기관<img src="image/small_arrow_top.png"></li>
                <li>협력기관<img src="image/small_arrow_top.png"></li>
            </ul>
        </div>
        <div class="footer_bottom">
            <img src="image/logo_ft.png">
            <div>
                <ul class="footer_01">
                    <li>개인정보처리방침</li>
                    <li>행정서비스현장</li>
                    <li>영상정보처리기기 운영</li>
                    <li>이메일집단수집거부</li>
                    <li>찾아오시는길</li>
                </ul>
                <ul class="footer_02">
                    <li>(42672) 대구광역시 달서구 공원순환로 201</li>
                    <li>대표전화 : 053-430-7600</li>
                    <li>팩스 : 053-430-7609</li>
                </ul>
                <p>본 홈페이지에 게시된 전자우편주소는 개인정보보호법 및 정보통신망법에 따라 무단 수집을 거부합니다. Copyright © Daegu Arts Center All Right
                    Reserved</p>
            </div>
        </div>
    </footer>
</body>

</html>